<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>แบบฟอร์มเช็คชื่อเข้า - ออกพนักงาน</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 500px;
      margin: auto;
      padding: 20px;
      background-color: #f4f4f4;
    }
    h2 {
      color: #2c3e50;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin: 5px 0 15px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    input[type="submit"] {
      background-color: #27ae60;
      color: white;
      border: none;
      cursor: pointer;
    }
    #status {
      font-weight: bold;
      margin-bottom: 15px;
    }
  </style>
  <script>
    let userLat = null;
    let userLng = null;

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function (position) {
            userLat = position.coords.latitude;
            userLng = position.coords.longitude;
            document.getElementById("status").innerText = "✅ ตรวจสอบตำแหน่งเรียบร้อยแล้ว";
          },
          function (error) {
            document.getElementById("status").innerText = "❌ ไม่สามารถดึงตำแหน่งที่ตั้งได้";
          }
        );
      } else {
        document.getElementById("status").innerText = "❌ เบราว์เซอร์ไม่รองรับการดึงตำแหน่ง";
      }
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const φ1 = lat1 * Math.PI/180;
      const φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2 - lat1) * Math.PI/180;
      const Δλ = (lon2 - lon1) * Math.PI/180;
      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function handleSubmit(event) {
      event.preventDefault();

      const form = document.getElementById("checkinForm");
      const branch = form.branch.value;

      let officeLat = 13.73820;
      let officeLng = 100.57467;
      if (branch === "ไมอามี่43") {
        officeLat = 13.75031;
        officeLng = 100.55866;
      }

      const distance = calculateDistance(userLat, userLng, officeLat, officeLng);
      if (distance > 100) {
        alert("❌ คุณอยู่นอกพื้นที่ ไม่สามารถส่งฟอร์มได้");
        return;
      }

      const formData = new FormData(form);
      formData.append("latitude", userLat);
      formData.append("longitude", userLng);

      fetch("https://script.google.com/macros/s/AKfycbyKzPezH4cIXus9tW0LsGp5vy5rDnY6EEmSv7hxmWthwiorqNTjTz4VSSnU9WB-3ofCGA/exec", {
        method: "POST",
        mode: "no-cors",
        body: formData
      })
      .then(() => {
        alert("✅ ส่งข้อมูลเรียบร้อยแล้ว");
        form.reset();
      })
      .catch(error => {
        console.error("Fetch error:", error);
        alert("❌ เกิดข้อผิดพลาดในการส่งข้อมูล");
      });
    }

    window.onload = getLocation;
  </script>
</head>
<body>
  <h2>แบบฟอร์มเช็คชื่อเข้า - ออกพนักงาน</h2>
  <p id="status">⏳ กำลังตรวจสอบตำแหน่ง...</p>
  <form id="checkinForm" onsubmit="handleSubmit(event)">
    <label for="branch">สาขา:</label>
    <select id="branch" name="branch" required>
      <option value="">--เลือกสาขา--</option>
      <option value="ไมอามี่49">ไมอามี่49</option>
      <option value="ไมอามี่43">ไมอามี่43</option>
    </select>

    <label for="name">ชื่อ - นามสกุล (EN):</label>
    <input type="text" id="name" name="name" required />

    <label for="department">แผนก:</label>
    <select id="department" name="department" required>
      <option value="">--เลือกแผนก--</option>
      <option value="แม่บ้านส่วนกลาง">แม่บ้านส่วนกลาง</option>
      <option value="แม่บ้านทำห้อง">แม่บ้านทำห้อง</option>
      <option value="พนักงานประชาสัมพันธ์">พนักงานประชาสัมพันธ์</option>
      <option value="ช่างบำรุงอาคาร">ช่างบำรุงอาคาร</option>
      <option value="พนักงานขับรถ">พนักงานขับรถ</option>
      <option value="พนักงานรักษาความปลอดภัย">พนักงานรักษาความปลอดภัย</option>
    </select>

    <label for="event">เหตุการณ์:</label>
    <select id="event" name="event" required>
      <option value="">--เลือกเหตุการณ์--</option>
      <option value="Check - in เข้ามาทำงาน">Check - in เข้ามาทำงาน</option>
      <option value="Check - Out ออกจากที่ทำงาน">Check - Out ออกจากที่ทำงาน</option>
      <option value="ลาป่วย มีใบรับรองแพทย์">ลาป่วย มีใบรับรองแพทย์</option>
      <option value="ลาป่วย ไม่มีใบรับรองแพทย์">ลาป่วย ไม่มีใบรับรองแพทย์</option>
      <option value="ลากิจ">ลากิจ</option>
      <option value="ลาหยุด PH">ลาหยุด PH</option>
      <option value="วันหยุดประจำสัปดาห์">วันหยุดประจำสัปดาห์</option>
    </select>

    <input type="submit" value="ส่งฟอร์ม" />
  </form>
</body>
</html>
